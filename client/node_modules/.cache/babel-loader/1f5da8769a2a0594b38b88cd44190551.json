{"ast":null,"code":"/* eslint callback-return:0 */\n'use strict';\n\nvar __extends = this && this.__extends || function () {\n  var _extendStatics = function extendStatics(d, b) {\n    _extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) {\n        if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n      }\n    };\n\n    return _extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n\n    _extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar EventEmitter = require('events');\n\nvar nInstances = 0;\n\nvar MediaSignaling = function (_super) {\n  __extends(MediaSignaling, _super);\n  /**\n   * Construct a {@link MediaSignaling}.\n   * @param {Promise<DataTrackReceiver>} getReceive\n   * @param {string} channel\n   */\n\n\n  function MediaSignaling(getReceiver, channel, options) {\n    var _this = _super.call(this) || this;\n\n    Object.defineProperties(_this, {\n      _instanceId: {\n        value: nInstances++\n      },\n      channel: {\n        value: channel\n      },\n      _log: {\n        value: options.log.createLog('default', _this)\n      },\n      _getReceiver: {\n        value: getReceiver\n      },\n      _receiverPromise: {\n        value: null,\n        writable: true\n      },\n      _transport: {\n        value: null,\n        writable: true\n      }\n    });\n    return _this;\n  }\n\n  Object.defineProperty(MediaSignaling.prototype, \"isSetup\", {\n    get: function get() {\n      return !!this._receiverPromise;\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  MediaSignaling.prototype.toString = function () {\n    return \"[MediaSignaling #\" + this._instanceId + \":\" + this.channel + \"]\";\n  };\n\n  MediaSignaling.prototype.setup = function (id) {\n    var _this = this;\n\n    this._teardown();\n\n    this._log.info('setting up msp transport for id:', id);\n\n    var receiverPromise = this._getReceiver(id).then(function (receiver) {\n      if (receiver.kind !== 'data') {\n        _this._log.error('Expected a DataTrackReceiver');\n\n        throw new Error('Expected a DataTrackReceiver');\n      }\n\n      if (_this._receiverPromise !== receiverPromise) {\n        return;\n      }\n\n      try {\n        _this._transport = receiver.toDataTransport();\n      } catch (ex) {\n        _this._log.error('Failed to toDataTransport');\n\n        throw new Error('Failed to toDataTransport');\n      }\n\n      _this.emit('ready', _this._transport);\n\n      receiver.once('close', function () {\n        return _this._teardown();\n      });\n    });\n\n    this._receiverPromise = receiverPromise;\n  };\n\n  MediaSignaling.prototype._teardown = function () {\n    if (this._transport) {\n      this._log.info('Tearing down');\n\n      this._transport = null;\n      this._receiverPromise = null;\n      this.emit('teardown');\n    }\n  };\n\n  return MediaSignaling;\n}(EventEmitter);\n\nmodule.exports = MediaSignaling;","map":{"version":3,"sources":["../../../lib/signaling/v2/mediasignaling.js"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/* eslint callback-return:0 */\n'use strict';\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        if (typeof b !== \"function\" && b !== null)\n            throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nvar EventEmitter = require('events');\nvar nInstances = 0;\nvar MediaSignaling = /** @class */ (function (_super) {\n    __extends(MediaSignaling, _super);\n    /**\n     * Construct a {@link MediaSignaling}.\n     * @param {Promise<DataTrackReceiver>} getReceive\n     * @param {string} channel\n     */\n    function MediaSignaling(getReceiver, channel, options) {\n        var _this = _super.call(this) || this;\n        Object.defineProperties(_this, {\n            _instanceId: {\n                value: nInstances++\n            },\n            channel: {\n                value: channel,\n            },\n            _log: {\n                value: options.log.createLog('default', _this)\n            },\n            _getReceiver: {\n                value: getReceiver\n            },\n            _receiverPromise: {\n                value: null,\n                writable: true,\n            },\n            _transport: {\n                value: null,\n                writable: true\n            }\n        });\n        return _this;\n    }\n    Object.defineProperty(MediaSignaling.prototype, \"isSetup\", {\n        get: function () {\n            return !!this._receiverPromise;\n        },\n        enumerable: false,\n        configurable: true\n    });\n    MediaSignaling.prototype.toString = function () {\n        return \"[MediaSignaling #\" + this._instanceId + \":\" + this.channel + \"]\";\n    };\n    MediaSignaling.prototype.setup = function (id) {\n        var _this = this;\n        this._teardown();\n        this._log.info('setting up msp transport for id:', id);\n        var receiverPromise = this._getReceiver(id).then(function (receiver) {\n            if (receiver.kind !== 'data') {\n                _this._log.error('Expected a DataTrackReceiver');\n                throw new Error('Expected a DataTrackReceiver');\n            }\n            if (_this._receiverPromise !== receiverPromise) {\n                return;\n            }\n            try {\n                _this._transport = receiver.toDataTransport();\n            }\n            catch (ex) {\n                _this._log.error('Failed to toDataTransport');\n                throw new Error('Failed to toDataTransport');\n            }\n            _this.emit('ready', _this._transport);\n            receiver.once('close', function () { return _this._teardown(); });\n        });\n        this._receiverPromise = receiverPromise;\n    };\n    MediaSignaling.prototype._teardown = function () {\n        if (this._transport) {\n            this._log.info('Tearing down');\n            this._transport = null;\n            this._receiverPromise = null;\n            this.emit('teardown');\n        }\n    };\n    return MediaSignaling;\n}(EventEmitter));\nmodule.exports = MediaSignaling;\n//# sourceMappingURL=mediasignaling.js.map"]},"metadata":{},"sourceType":"script"}