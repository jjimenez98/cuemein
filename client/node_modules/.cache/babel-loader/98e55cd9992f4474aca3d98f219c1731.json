{"ast":null,"code":"/* eslint callback-return:0 */\n'use strict';\n\nvar __extends = this && this.__extends || function () {\n  var _extendStatics = function extendStatics(d, b) {\n    _extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) {\n        if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n      }\n    };\n\n    return _extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n\n    _extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __read = this && this.__read || function (o, n) {\n  var m = typeof Symbol === \"function\" && o[Symbol.iterator];\n  if (!m) return o;\n  var i = m.call(o),\n      r,\n      ar = [],\n      e;\n\n  try {\n    while ((n === void 0 || n-- > 0) && !(r = i.next()).done) {\n      ar.push(r.value);\n    }\n  } catch (error) {\n    e = {\n      error: error\n    };\n  } finally {\n    try {\n      if (r && !r.done && (m = i[\"return\"])) m.call(i);\n    } finally {\n      if (e) throw e.error;\n    }\n  }\n\n  return ar;\n};\n\nvar EventEmitter = require('events');\n\nvar PeerConnectionReportFactory = require('../../stats/peerconnectionreportfactory');\n/**\n * @emits NetworkQualityMonitor#updated\n */\n\n\nvar NetworkQualityMonitor = function (_super) {\n  __extends(NetworkQualityMonitor, _super);\n  /**\n   * Construct a {@link NetworkQualityMonitor}.\n   * @param {PeerConnectionManager} manager\n   * @param {NetworkQualitySignaling} signaling\n   */\n\n\n  function NetworkQualityMonitor(manager, signaling) {\n    var _this = _super.call(this) || this;\n\n    Object.defineProperties(_this, {\n      _factories: {\n        value: new WeakMap()\n      },\n      _manager: {\n        value: manager\n      },\n      _signaling: {\n        value: signaling\n      }\n    });\n    signaling.on('updated', function () {\n      return _this.emit('updated');\n    });\n    return _this;\n  }\n\n  Object.defineProperty(NetworkQualityMonitor.prototype, \"level\", {\n    /**\n     * Get the current {@link NetworkQualityLevel}, if any.\n     * @returns {?NetworkQualityLevel} level - initially null\n     */\n    get: function get() {\n      return this._signaling.level;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(NetworkQualityMonitor.prototype, \"levels\", {\n    /**\n     * Get the current {@link NetworkQualityLevels}, if any.\n     * @returns {?NetworkQualityLevels} levels - initially null\n     */\n    get: function get() {\n      return this._signaling.levels;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(NetworkQualityMonitor.prototype, \"remoteLevels\", {\n    /**\n     * Get the current {@link NetworkQualityLevels} of remote participants, if any.\n     * @returns {Map<String, NetworkQualityLevels>} remoteLevels\n     */\n    get: function get() {\n      return this._signaling.remoteLevels;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  /**\n   * Start monitoring.\n   * @returns {void}\n   */\n\n  NetworkQualityMonitor.prototype.start = function () {\n    var _this = this;\n\n    this.stop();\n    var timeout = setTimeout(function () {\n      if (_this._timeout !== timeout) {\n        return;\n      }\n\n      next(_this).then(function (reports) {\n        if (_this._timeout !== timeout) {\n          return;\n        }\n\n        if (reports.length) {\n          var _a = __read(reports, 1),\n              report = _a[0];\n\n          _this._signaling.put(report);\n        }\n\n        _this.start();\n      });\n    }, 200);\n    this._timeout = timeout;\n  };\n  /**\n   * Stop monitoring.\n   * @returns {void}\n   */\n\n\n  NetworkQualityMonitor.prototype.stop = function () {\n    clearTimeout(this._timeout);\n    this._timeout = null;\n  };\n\n  return NetworkQualityMonitor;\n}(EventEmitter);\n/**\n * @param {NetworkQualityMonitor}\n * @returns {Promise<NetworkQualityInputs>}\n */\n\n\nfunction next(monitor) {\n  var pcv2s = monitor._manager._peerConnections ? Array.from(monitor._manager._peerConnections.values()) : [];\n  var pcs = pcv2s.map(function (pcv2) {\n    return pcv2._peerConnection;\n  }).filter(function (pc) {\n    return pc.signalingState !== 'closed';\n  });\n  var factories = pcs.map(function (pc) {\n    if (monitor._factories.has(pc)) {\n      return monitor._factories.get(pc);\n    }\n\n    var factory = new PeerConnectionReportFactory(pc);\n\n    monitor._factories.set(pc, factory);\n\n    return factory;\n  });\n  var reportsOrNullPromises = factories.map(function (factory) {\n    return factory.next().catch(function () {\n      return null;\n    });\n  });\n  return Promise.all(reportsOrNullPromises).then(function (reportsOrNull) {\n    return reportsOrNull.filter(function (reportOrNull) {\n      return reportOrNull;\n    }).map(function (report) {\n      return report.summarize();\n    });\n  });\n}\n/**\n * The {@link NetworkQualityLevel} changed.\n * @event NetworkQualityMonitor#updated\n */\n\n\nmodule.exports = NetworkQualityMonitor;","map":{"version":3,"sources":["../../../lib/signaling/v2/networkqualitymonitor.js"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/* eslint callback-return:0 */\n'use strict';\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        if (typeof b !== \"function\" && b !== null)\n            throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nvar __read = (this && this.__read) || function (o, n) {\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator];\n    if (!m) return o;\n    var i = m.call(o), r, ar = [], e;\n    try {\n        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\n    }\n    catch (error) { e = { error: error }; }\n    finally {\n        try {\n            if (r && !r.done && (m = i[\"return\"])) m.call(i);\n        }\n        finally { if (e) throw e.error; }\n    }\n    return ar;\n};\nvar EventEmitter = require('events');\nvar PeerConnectionReportFactory = require('../../stats/peerconnectionreportfactory');\n/**\n * @emits NetworkQualityMonitor#updated\n */\nvar NetworkQualityMonitor = /** @class */ (function (_super) {\n    __extends(NetworkQualityMonitor, _super);\n    /**\n     * Construct a {@link NetworkQualityMonitor}.\n     * @param {PeerConnectionManager} manager\n     * @param {NetworkQualitySignaling} signaling\n     */\n    function NetworkQualityMonitor(manager, signaling) {\n        var _this = _super.call(this) || this;\n        Object.defineProperties(_this, {\n            _factories: {\n                value: new WeakMap()\n            },\n            _manager: {\n                value: manager\n            },\n            _signaling: {\n                value: signaling\n            }\n        });\n        signaling.on('updated', function () { return _this.emit('updated'); });\n        return _this;\n    }\n    Object.defineProperty(NetworkQualityMonitor.prototype, \"level\", {\n        /**\n         * Get the current {@link NetworkQualityLevel}, if any.\n         * @returns {?NetworkQualityLevel} level - initially null\n         */\n        get: function () {\n            return this._signaling.level;\n        },\n        enumerable: false,\n        configurable: true\n    });\n    Object.defineProperty(NetworkQualityMonitor.prototype, \"levels\", {\n        /**\n         * Get the current {@link NetworkQualityLevels}, if any.\n         * @returns {?NetworkQualityLevels} levels - initially null\n         */\n        get: function () {\n            return this._signaling.levels;\n        },\n        enumerable: false,\n        configurable: true\n    });\n    Object.defineProperty(NetworkQualityMonitor.prototype, \"remoteLevels\", {\n        /**\n         * Get the current {@link NetworkQualityLevels} of remote participants, if any.\n         * @returns {Map<String, NetworkQualityLevels>} remoteLevels\n         */\n        get: function () {\n            return this._signaling.remoteLevels;\n        },\n        enumerable: false,\n        configurable: true\n    });\n    /**\n     * Start monitoring.\n     * @returns {void}\n     */\n    NetworkQualityMonitor.prototype.start = function () {\n        var _this = this;\n        this.stop();\n        var timeout = setTimeout(function () {\n            if (_this._timeout !== timeout) {\n                return;\n            }\n            next(_this).then(function (reports) {\n                if (_this._timeout !== timeout) {\n                    return;\n                }\n                if (reports.length) {\n                    var _a = __read(reports, 1), report = _a[0];\n                    _this._signaling.put(report);\n                }\n                _this.start();\n            });\n        }, 200);\n        this._timeout = timeout;\n    };\n    /**\n     * Stop monitoring.\n     * @returns {void}\n     */\n    NetworkQualityMonitor.prototype.stop = function () {\n        clearTimeout(this._timeout);\n        this._timeout = null;\n    };\n    return NetworkQualityMonitor;\n}(EventEmitter));\n/**\n * @param {NetworkQualityMonitor}\n * @returns {Promise<NetworkQualityInputs>}\n */\nfunction next(monitor) {\n    var pcv2s = monitor._manager._peerConnections\n        ? Array.from(monitor._manager._peerConnections.values())\n        : [];\n    var pcs = pcv2s\n        .map(function (pcv2) { return pcv2._peerConnection; })\n        .filter(function (pc) { return pc.signalingState !== 'closed'; });\n    var factories = pcs.map(function (pc) {\n        if (monitor._factories.has(pc)) {\n            return monitor._factories.get(pc);\n        }\n        var factory = new PeerConnectionReportFactory(pc);\n        monitor._factories.set(pc, factory);\n        return factory;\n    });\n    var reportsOrNullPromises = factories.map(function (factory) { return factory.next().catch(function () { return null; }); });\n    return Promise.all(reportsOrNullPromises).then(function (reportsOrNull) { return reportsOrNull\n        .filter(function (reportOrNull) { return reportOrNull; })\n        .map(function (report) { return report.summarize(); }); });\n}\n/**\n * The {@link NetworkQualityLevel} changed.\n * @event NetworkQualityMonitor#updated\n */\nmodule.exports = NetworkQualityMonitor;\n//# sourceMappingURL=networkqualitymonitor.js.map"]},"metadata":{},"sourceType":"script"}